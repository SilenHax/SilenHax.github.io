<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G≈Çosowanie - Konkurs Piosenki</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
/* Je≈õli nie u≈ºywasz pluginu Tailwind line-clamp, dodaj to rƒôcznie */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>

</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-white mb-3 drop-shadow-lg">üé§ Konkurs Piosenki</h1>
            <p class="text-xl text-purple-200">Oddaj sw√≥j g≈Ços na ulubionego uczestnika!</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-400"></div>
            <p class="text-white mt-4 text-lg">Sprawdzam kod g≈Çosowania...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden">
            <div class="bg-red-500/20 border-2 border-red-400 rounded-2xl p-8 backdrop-blur-sm">
                <div class="text-center">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h2 class="text-3xl font-bold text-white mb-3" id="error-title">B≈ÇƒÖd</h2>
                    <p class="text-red-200 text-lg" id="error-message"></p>
                </div>
            </div>
        </div>

        <!-- Voting State -->
        <div id="voting" class="hidden">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 shadow-2xl border border-white/20">
                <h2 class="text-3xl font-bold text-white mb-6 text-center">Wybierz swojego faworyta:</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch" id="candidates"></div>
            </div>
        </div>

         <!-- Success State -->
        <div id="success" class="hidden">
            <div class="bg-green-500/20 border-2 border-green-400 rounded-2xl p-8 backdrop-blur-sm">
                <div class="text-center">
                    <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                    <h2 class="text-3xl font-bold text-white mb-3">Dziƒôkujemy za g≈Ços!</h2>
                    <p class="text-green-200 text-lg mb-4">Tw√≥j g≈Ços zosta≈Ç zapisany na:</p>
                    <div class="bg-white/20 rounded-xl p-4 inline-block mb-6">
                        <p class="text-2xl font-bold text-white" id="voted-candidate"></p>
                    </div>
                    <div>
                        <a href="https://silenhax.pl/results.html" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 hover:shadow-2xl">
                            üìä Zobacz wyniki na ≈ºywo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfiguracja Supabase - ZASTƒÑP SWOIMI DANYMI
        const SUPABASE_URL = 'https://sbcqfgackqadypynxuou.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_0DB_RLitMw4sucuFfs-rHQ_7MIRaA2T';


        // Funkcja pomocnicza do tworzenia klienta z custom headers
        function getSupabaseClient(token) {
            return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: {
                    headers: {
                        'x-voting-token': token
                    }
                }
            });
        }

        // Lista kandydat√≥w
        const candidates = [
            { id: 1, name: 'Michael\'s Band', song: '"Sway" - Michael Buble' },
            { id: 2, name: 'Katarzyna Swat', song: '"Wonderwall" - Oasis' },
            { id: 3, name: 'Zuzanna Trochim', song: '"Riptide" - Vance Joy'},
            { id: 4, name: 'Wojtek Zi√≥≈Çek, Ala Lizanowicz, Oliwia J√≥≈∫wik', song: '"Creep" - Radiohead'},
            { id: 5, name: 'Marta FrƒÖczek', song: '"My heart will go on" - Celine Dion' },
            { id: 6, name: 'Zesp√≥≈Ç rodzinka.pl', song: '"We will rock you" - Queen' },
            { id: 7, name: 'Kacper Chylicki z zespo≈Çem', song: '"Die with a smile" - Lady Gaga, Bruno Mars' },
            { id: 8, name: 'zesp√≥≈Ç Wack', song: '"Where is my mind?" - Pixies'  }
        ];

        // Elementy DOM
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const votingEl = document.getElementById('voting');
        const successEl = document.getElementById('success');
        const candidatesEl = document.getElementById('candidates');

	let statusCheckInterval;

// Funkcja czyszczƒÖca wszystko po sukcesie
function stopAllBackgroundTraffic() {
    if (statusCheckInterval) clearInterval(statusCheckInterval);
    // Usuwamy klienta Supabase z pamiƒôci, by zamknƒÖƒá po≈ÇƒÖczenia
    console.log('üîå Zamykanie po≈ÇƒÖcze≈Ñ t≈Ça...');
}
	
        // Pobierz token z URL
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        // Walidacja choiceId
        function isValidChoiceId(choiceId) {
            return Number.isInteger(choiceId) && choiceId >= 1 && choiceId <= 8;
        }

        // Poka≈º b≈ÇƒÖd
        function showError(title, message) {
            loadingEl.classList.add('hidden');
            votingEl.classList.add('hidden');
            successEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
        }

        // Poka≈º stronƒô g≈Çosowania
        function showVoting() {
            loadingEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');
            votingEl.classList.remove('hidden');
        }

        // Poka≈º sukces
        // Modyfikacja showSuccess
function showSuccess(candidateName) {
    stopAllBackgroundTraffic(); // STOP dla zapyta≈Ñ
    loadingEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    votingEl.classList.add('hidden');
    successEl.classList.remove('hidden');
    document.getElementById('voted-candidate').textContent = candidateName;
}

        // Sprawd≈∫ czy g≈Çosowanie jest aktywne
        async function checkVotingActive(client) {
            try {
                console.log('üîç Sprawdzam czy g≈Çosowanie jest aktywne...');
                
                const { data, error } = await client
                    .from('app_config')
                    .select('value')
                    .eq('key', 'voting_active')
                    .single();

                if (error) {
                    console.error('‚ùå B≈ÇƒÖd sprawdzania statusu g≈Çosowania:', error);
                    return false;
                }

                console.log('üìä Status g≈Çosowania:', data);
                return data?.value === true;
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd sprawdzania voting_active:', error);
                return false;
            }
        }

        // Sprawd≈∫ token w bazie
        async function checkToken(token) {
            try {
                console.log('üîç Sprawdzam token:', token);
                
                const client = getSupabaseClient(token);
    const isVotingActive = await checkVotingActive(client);
    
    if (!isVotingActive) {
        showError('G≈Çosowanie zamkniƒôte', 'G≈Çosowanie nie jest obecnie aktywne.');
        // Ustawiamy sprawdzanie statusu, by strona sama "o≈ºy≈Ça" gdy admin w≈ÇƒÖczy g≈Çosowanie
        if(!statusCheckInterval) statusCheckInterval = setInterval(() => checkToken(token), 10000);
        return null;
    }
    
    // Je≈õli g≈Çosowanie aktywne, czy≈õcimy interwa≈Ç sprawdzania statusu
    if (statusCheckInterval) clearInterval(statusCheckInterval);
                
                const { data, error } = await client
                    .from('VotingTokens')
                    .select('*')
                    .eq('token', token)
                    .single();

                console.log('üìä Odpowied≈∫ z Supabase:', { data, error });

                if (error) {
                    console.error('‚ùå B≈ÇƒÖd Supabase:', error);
                    if (error.code === 'PGRST116') {
                        showError('Nieprawid≈Çowy kod', 'Podany kod g≈Çosowania nie istnieje.');
                        return null;
                    }
                    showError('B≈ÇƒÖd po≈ÇƒÖczenia', `B≈ÇƒÖd: ${error.message}. Sprawd≈∫ konfiguracjƒô Supabase i RLS.`);
                    return null;
                }

                console.log('‚úÖ Dane tokenu:', data);

                if (data.has_voted) {
                    showError('Kod ju≈º wykorzystany', 'Ten kod zosta≈Ç ju≈º u≈ºyty do g≈Çosowania.');
                    return null;
                }

                return data;
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd sprawdzania tokenu:', error);
                showError('B≈ÇƒÖd', `WystƒÖpi≈Ç b≈ÇƒÖd: ${error.message}`);
                return null;
            }
        }

        // Zag≈Çosuj
        async function vote(token, choiceId) {
            // Walidacja lokalna
            if (!isValidChoiceId(choiceId)) {
                showError('B≈ÇƒÖd', 'Nieprawid≈Çowy wyb√≥r kandydata.');
                return;
            }

            try {
                console.log('üó≥Ô∏è G≈Çosujƒô na kandydata:', choiceId);
                
                const client = getSupabaseClient(token);
                
                // Sprawd≈∫ czy g≈Çosowanie jest nadal aktywne przed zapisem
                const isVotingActive = await checkVotingActive(client);
                
                if (!isVotingActive) {
                    showError('G≈Çosowanie zamkniƒôte', 'G≈Çosowanie zosta≈Ço zako≈Ñczone. Nie mo≈ºna ju≈º oddawaƒá g≈Ços√≥w.');
                    return;
                }
                
                const { data, error } = await client
                    .from('VotingTokens')
                    .update({ 
                        has_voted: true, 
                        choiceId: choiceId 
                    })
                    .eq('token', token)
                    .eq('has_voted', false)
                    .select()
                    .single();

                console.log('üìä Wynik g≈Çosowania:', { data, error });

                console.log('üìä Wynik g≈Çosowania:', { data, error });

                if (error) {
                    console.error('‚ùå B≈ÇƒÖd g≈Çosowania:', error);
                    if (error.code === 'PGRST116') {
                        showError('Kod ju≈º wykorzystany', 'Ten kod zosta≈Ç ju≈º u≈ºyty do g≈Çosowania.');
                        return;
                    }
                    throw error;
                }

                console.log('‚úÖ G≈Ços zapisany pomy≈õlnie!');
                const candidate = candidates.find(c => c.id === choiceId);
                showSuccess(`${candidate.name} - ${candidate.song}`);
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd zapisu g≈Çosu:', error);
                showError('B≈ÇƒÖd', `WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania g≈Çosu: ${error.message}`);
            }
        }

        // Renderuj kandydat√≥w
        function renderCandidates(token) {
            candidatesEl.innerHTML = candidates.map(candidate => `
                <button 
                    onclick="handleVote('${token}', ${candidate.id})"
                    class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 
                           text-white font-bold py-6 px-6 rounded-xl shadow-lg 
                           transform transition-all duration-200 hover:scale-105 hover:shadow-2xl
                           active:scale-95 text-left"
                >
                    <div class="flex items-center gap-4">
                        <div class="text-4xl font-bold bg-white/20 rounded-full w-14 h-14 flex items-center justify-center">
                            ${candidate.id}
                        </div>
                        <div>
                            <div class="text-xl font-bold">${candidate.name}</div>
                            <div class="text-purple-100 text-sm">${candidate.song}</div>
                        </div>
                    </div>
                </button>
            `).join('');
        }

        // Obs≈Çuga g≈Çosowania
        window.handleVote = async function(token, choiceId) {
            // Zablokuj przyciski
            const buttons = candidatesEl.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });

            await vote(token, choiceId);
        };

        // Inicjalizacja
        async function init() {
            console.log('üöÄ Inicjalizacja aplikacji...');
            const token = getTokenFromURL();
            console.log('üîë Token z URL:', token);

            if (!token) {
                showError('Brak kodu', 'Nie podano kodu g≈Çosowania w adresie URL. Sprawd≈∫ link i spr√≥buj ponownie.');
                return;
            }

            const tokenData = await checkToken(token);
            console.log('üìã Wynik sprawdzenia tokenu:', tokenData);
            
            if (tokenData) {
                console.log('‚úÖ Token jest wa≈ºny, pokazujƒô formularz g≈Çosowania');
                renderCandidates(token);
                showVoting();
            } else {
                console.log('‚ùå Token jest niewa≈ºny lub wystƒÖpi≈Ç b≈ÇƒÖd');
            }
        }

        // Uruchom przy za≈Çadowaniu strony
        init();
    </script>
</body>
</html>
