<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Centrum Dowodzenia - Konkurs Piosenki</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: white; }
        .card { background-color: #2d2d2d; color: white; border: 1px solid #444; }
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; }
        #dashboard { display: none; padding: 20px; }
        .status-dot { height: 15px; width: 15px; background-color: red; border-radius: 50%; display: inline-block; }
        .status-active { background-color: #0f0; box-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="card p-4" style="width: 350px;">
        <h3 class="text-center mb-4">Logowanie Admina</h3>
        <input type="email" id="email" class="form-control mb-2" placeholder="Email">
        <input type="password" id="password" class="form-control mb-3" placeholder="Hasło">
        <button onclick="login()" class="btn btn-primary w-100">Zaloguj</button>
        <p id="login-msg" class="text-danger mt-2 text-center"></p>
    </div>
</div>

<div id="dashboard">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1>Wyniki na żywo</h1>
        </div>
        <div class="col-md-6 text-end">
            <div class="card p-3 d-inline-block">
                <span>Status Głosowania: </span>
                <span id="status-indicator" class="status-dot mx-2"></span>
                <button id="toggle-btn" onclick="toggleVoting()" class="btn btn-sm btn-light">Włącz/Wyłącz</button>
            </div>
            <button onclick="logout()" class="btn btn-sm btn-outline-danger ms-3">Wyloguj</button>
        </div>
    </div>

    <div class="card p-3 mb-4" style="height: 400px;">
        <canvas id="resultsChart"></canvas>
    </div>

    <div class="card p-3">
        <h5>Strefa Zagrożenia (Troubleshooting)</h5>
        <div class="d-flex gap-2">
            <button onclick="refreshData()" class="btn btn-warning">Wymuś odświeżenie danych</button>
            <button onclick="resetApp()" class="btn btn-outline-secondary">Zresetuj widok admina</button>
        </div>
        <small class="text-muted mt-2">W przypadku totalnej awarii, wejdź bezpośrednio na supabase.com</small>
    </div>
</div>

<script>
const { createClient } = window.supabase;
    // KONFIGURACJA
    const SUPABASE_URL = 'https://sbcqfgackqadypynxuou.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_0DB_RLitMw4sucuFfs-rHQ_7MIRaA2T'; // Tak, tutaj też ANON key!
    // Używamy okna (window), aby odwołać się do biblioteki i nazywamy zmienną inaczej
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let votingActive = false;
    let myChart = null;

async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    try {
        // Sprawdzamy w konsoli czy auth istnieje (do debugowania)
        console.log("Próba logowania...", supabaseClient.auth);

        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
        });
        
        if (error) throw error;

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();

    } catch (error) {
        console.error("Błąd logowania:", error);
        document.getElementById('login-msg').innerText = "Błąd: " + error.message;
    }
}

    async function logout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // 2. INICJALIZACJA DASHBOARDU
    async function initDashboard() {
        checkVotingStatus();
        setupChart();
        fetchResults();
        
        // Subskrypcja na zmiany w czasie rzeczywistym (Realtime)
        supabase.channel('public:votes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, payload => {
                console.log('Nowy głos!', payload);
                fetchResults(); // Odśwież wykres
            })
            .subscribe();
    }

    // 3. OBSŁUGA STATUSU GŁOSOWANIA
    async function checkVotingStatus() {
        const { data } = await supabase.from('app_config').select('value').eq('key', 'voting_active').single();
        if (data) {
            updateStatusUI(data.value);
        }
    }

    async function toggleVoting() {
        const newState = !votingActive;
        const { error } = await supabase.from('app_config').update({ value: newState }).eq('key', 'voting_active');
        if (!error) updateStatusUI(newState);
    }

    function updateStatusUI(isActive) {
        votingActive = isActive;
        const dot = document.getElementById('status-indicator');
        const btn = document.getElementById('toggle-btn');
        
        if (isActive) {
            dot.classList.add('status-active');
            btn.innerText = "ZATRZYMAJ GŁOSOWANIE";
            btn.classList.replace('btn-light', 'btn-danger');
        } else {
            dot.classList.remove('status-active');
            btn.innerText = "ROZPOCZNIJ GŁOSOWANIE";
            btn.classList.replace('btn-danger', 'btn-light');
        }
    }

    // 4. WYKRES I DANE
    async function fetchResults() {
        // Pobieramy wszystkie głosy (dzięki Auth i RLS Admin widzi wszystko)
        const { data, error } = await supabase.from('votes').select('choice_id').eq('has_voted', true);
        
        if (error) return console.error(error);

        // Zliczanie głosów
        const counts = new Array(11).fill(0); // Indeksy 1-10
        data.forEach(vote => {
            if (vote.choice_id >= 1 && vote.choice_id <= 10) {
                counts[vote.choice_id]++;
            }
        });

        // Aktualizacja wykresu
        myChart.data.datasets[0].data = counts.slice(1); // Ucinamy indeks 0
        myChart.update();
    }

    function setupChart() {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Kandydat 1', 'Kandydat 2', 'Kandydat 3', 'Kandydat 4', 'Kandydat 5', 'Kandydat 6', 'Kandydat 7', 'Kandydat 8', 'Kandydat 9', 'Kandydat 10'],
                datasets: [{
                    label: 'Liczba głosów',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    function refreshData() { fetchResults(); }
    function resetApp() { location.reload(); }

</script>
</body>
</html>
